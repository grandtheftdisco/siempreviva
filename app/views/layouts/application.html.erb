<!DOCTYPE html>
<html>
  <%= render partial: "layouts/public/head" %>

  <body>
    <header class="relative">
      <div class="header-container">
          
        <!-- Logo -->
        <div class="logo-section">
          <a href="<%= root_path %>" class="logo-link">
            <%= image_tag 'logo.png', class: 'logo-image', alt: 'Logo' %>
          </a>
        </div>
      
        <!-- Navbar Links -->
        <div class="navbar-section hidden md:flex" id="navbar-default">
          <ul class="navbar-list">
            <li><%= link_to 'products', products_path %></li>
            <li><%= link_to 'our farms', our_farms_path %></li> 
            <li><%= link_to 'learn', learn_path %></li>
            <li><%= link_to 'contact', contact_path %></li>
          </ul>
        </div>

        <!-- Desktop Search Section -->
        <div class="search-section hidden md:flex">
          <div class="search-desktop">
            <div id="searchbox-desktop" class="search-container"></div>
            <div id="hits-desktop" class="search-results"></div>
          </div>
        </div>

        <!-- Desktop Cart Section -->
        <div class="right-icons hidden md:flex">
          <!-- Cart Dropdown -->
          <button id="cartDropdownButton" class="cart-button">
            <!-- Shopping Cart Icon -->
            <svg class="cart-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 10.5V6a3.75 3.75 0 10-7.5 0v4.5m11.356-1.993l1.263 12c.07.665-.45 1.243-1.119 1.243H4.25a1.125 1.125 0 01-1.12-1.243l1.264-12A1.125 1.125 0 015.513 7.5h12.974c.576 0 1.059.435 1.119.993zM8.625 10.5a.375.375 0 11-.75 0 .375.375 0 01.75 0zm7.5 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z"></path>
            </svg>
            <!-- Cart Badge -->
            <span class="cart-badge"><%= @cart.cart_items.count %></span>
          </button>

          <!-- Dropdown Menu -->
          <div id="cartDropdown" class="cart-dropdown">
            <div class="cart-dropdown-header">
              <h3 class="cart-dropdown-title">my bag</h3>
            </div>
            <div class="cart-dropdown-content">
              <ul class="cart-items-list">
              <% @cart.cart_items.each do |item| %>
                  <li class="cart-item">
                    <div class="cart-item-details">
                      <p class="cart-item-name"><%= item.name %></p>
                      <p class="cart-item-price"><%= to_dollars(item.price) %></p>
                    </div>
                    <%= button_to '×', item, method: :delete, class: 'remove-button-small' %>
                  </li>
              <% end %>
              </ul>
            </div>
            <div class="cart-dropdown-footer">
              <div class="cart-summary">
                <div class="cart-summary-line">
                  <span>subtotal</span>
                  <span><%= to_dollars(@cart.total) %></span>
                </div>
                <div class="cart-summary-line">
                  <span>shipping</span>
                  <span>(calculated at checkout)</span>
                  <!-- TODO - add shipping in here once customer has selected it; ie if they begin checkout process & then abandon cart -->
                </div>
                <div class="cart-summary-line cart-total">
                  <span>total (before shipping)</span>
                  <span><%= to_dollars(@cart.total) %></span>
                </div>
              </div>
              <div class="cart-actions">
                <a href="<%= cart_path %>" class="cart-view-button">view cart</a>
                <a href="<%= new_checkout_path %>" class="cart-checkout-btn">checkout</a>
              </div>
            </div>
          </div>
        </div>

        <!-- Mobile Nav Items (Search + Right Icons) -->
        <div class="mobile-nav-items md:hidden">
          <!-- Mobile Search Section -->
          <div class="search-section">
            <!-- Search Icon Button (Mobile) -->
            <button id="searchToggleButton" class="search-toggle-button">
              <svg class="search-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z"></path>
              </svg>
            </button>
          </div>

          <!-- Mobile Right Side Icons -->
          <div class="right-icons">
          <!-- Mobile Cart Dropdown -->
          <button id="cartDropdownButtonMobile" class="cart-button">
            <!-- Shopping Cart Icon -->
            <svg class="cart-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 10.5V6a3.75 3.75 0 10-7.5 0v4.5m11.356-1.993l1.263 12c.07.665-.45 1.243-1.119 1.243H4.25a1.125 1.125 0 01-1.12-1.243l1.264-12A1.125 1.125 0 015.513 7.5h12.974c.576 0 1.059.435 1.119.993zM8.625 10.5a.375.375 0 11-.75 0 .375.375 0 01.75 0zm7.5 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z"></path>
            </svg>
            <!-- Cart Badge -->
            <span class="cart-badge"><%= @cart.cart_items.count %></span>
          </button>

          <!-- Mobile Dropdown Menu -->
          <div id="cartDropdownMobile" class="cart-dropdown">
            <div class="cart-dropdown-header">
              <h3 class="cart-dropdown-title">my bag</h3>
            </div>
            <div class="cart-dropdown-content">
              <ul class="cart-items-list">
              <% @cart.cart_items.each do |item| %>
                  <li class="cart-item">
                    <div class="cart-item-details">
                      <p class="cart-item-name"><%= item.name %></p>
                      <p class="cart-item-price"><%= to_dollars(item.price) %></p>
                    </div>
                    <%= button_to '×', item, method: :delete, class: 'remove-button-small' %>
                  </li>
              <% end %>
              </ul>
            </div>
            <div class="cart-dropdown-footer">
              <div class="cart-summary">
                <div class="cart-summary-line">
                  <span>subtotal</span>
                  <span><%= to_dollars(@cart.total) %></span>
                </div>
                <div class="cart-summary-line">
                  <span>shipping</span>
                  <span>(calculated at checkout)</span>
                  <!-- TODO - add shipping in here once customer has selected it; ie if they begin checkout process & then abandon cart -->
                </div>
                <div class="cart-summary-line cart-total">
                  <span>total</span>
                  <span><%= to_dollars(@cart.total) %></span>
                </div>
              </div>
              <div class="cart-actions">
                <a href="<%= cart_path %>" class="cart-view-button">view cart</a>
                <a href="<%= new_checkout_path %>" class="cart-checkout-btn">checkout</a>
              </div>
            </div>
          </div>

          <!-- Mobile Menu Button -->
          <button data-collapse-toggle="navbar-default" type="button" class="mobile-menu-button">
            <span class="sr-only">Open main menu</span>
            <svg class="mobile-menu-icon" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
          </button>
        </div>
        </div> <!-- End mobile-nav-items -->
        
        <!-- Search Dropdown (Mobile) - Moved outside search-section -->
        <div id="searchDropdown" class="search-dropdown">
          <div id="searchbox" class="search-container"></div>
          <div id="hits" class="search-results"></div>
        </div>
        </div> <!-- End header-container -->
      </header>
    <main>
      <%= ' class="has-flash-messages"'.html_safe if flash.any? %>
      <%= render partial: "layouts/public/flash_alert" %>
      <%= yield %>
    </main>
  </body>
</html>

<script>
  // Initialize the search client

  const { liteClient: algoliasearch } = window['algoliasearch/lite'];
  const searchClient = algoliasearch('<%= Rails.application.credentials.algolia[:application_id] %>',
                                     '<%= Rails.application.credentials.algolia[:search_api_key] %>');

  // Render the InstantSearch.js wrapper
  const search = instantsearch({
    indexName: 'products_index',
    searchClient,
    searchFunction(helper) {
      // only search if the query is not empty
      if (helper.state.query.trim() === '') {
        // hide hits container if query is empty
        document.querySelector('#hits').style.display = 'none';
        document.querySelector('#hits-desktop').style.display = 'none';
        return;
      }
      // show hits container and search
      document.querySelector('#hits').style.display = '';
      document.querySelector('#hits-desktop').style.display = '';
      helper.search();
    }
  });

  search.addWidgets([
    // Mobile searchbox
    instantsearch.widgets.searchBox({
      container: '#searchbox'
    }),
    // Desktop searchbox
    instantsearch.widgets.searchBox({
      container: '#searchbox-desktop'
    }),

    // Mobile hits
    instantsearch.widgets.hits({
      container: '#hits',
      templates: {
        item(hit, { html, components }) {

          const url = `/products/${hit.objectId}`;

          return html`
            <a href="${url}" class="search-hit-item">
              <h2>
                ${components.Highlight({ attribute: 'name', hit })}
              </h2>
            </a>
          `;
        },
      },
    }),
    
    // Desktop hits
    instantsearch.widgets.hits({
      container: '#hits-desktop',
      templates: {
        item(hit, { html, components }) {

          const url = `/products/${hit.objectId}`;

          return html`
            <a href="${url}" class="search-hit-item">
              <h2>
                ${components.Highlight({ attribute: 'name', hit })}
              </h2>
            </a>
          `;
        },
      },
    })
  ]);

  // hide hits on initial load
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelector('#hits').style.display = 'none';
    document.querySelector('#hits-desktop').style.display = 'none';

    // Search dropdown functionality
    const searchButton = document.getElementById('searchToggleButton');
    const searchDropdown = document.getElementById('searchDropdown');

    // Initially hide search dropdown
    if (searchDropdown) {
      searchDropdown.style.display = 'none';
    }

    if (searchButton && searchDropdown) {
      searchButton.addEventListener('click', function(e) {
        e.preventDefault();

        // Toggle display
        if (searchDropdown.style.display === 'none' || searchDropdown.style.display === '') {
          searchDropdown.style.display = 'block';
          
          // Auto-focus the search input on mobile for better UX
          setTimeout(() => {
            const searchInput = searchDropdown.querySelector('.ais-SearchBox-input');
            if (searchInput && window.innerWidth <= 768) {
              searchInput.focus();
            }
          }, 100);
        } else {
          searchDropdown.style.display = 'none';
        }
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', function(e) {
        if (!searchButton.contains(e.target) && !searchDropdown.contains(e.target)) {
          searchDropdown.style.display = 'none';
        }
      });
    }

    // Desktop Cart dropdown functionality
    const cartButton = document.getElementById('cartDropdownButton');
    const cartDropdown = document.getElementById('cartDropdown');

    if (cartButton && cartDropdown) {
      cartButton.addEventListener('click', function(e) {
        e.preventDefault();
        cartDropdown.classList.toggle('show');
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', function(e) {
        if (!cartButton.contains(e.target) && !cartDropdown.contains(e.target)) {
          cartDropdown.classList.remove('show');
        }
      });
    }

    // Mobile Cart dropdown functionality
    const cartButtonMobile = document.getElementById('cartDropdownButtonMobile');
    const cartDropdownMobile = document.getElementById('cartDropdownMobile');

    if (cartButtonMobile && cartDropdownMobile) {
      cartButtonMobile.addEventListener('click', function(e) {
        e.preventDefault();
        cartDropdownMobile.classList.toggle('show');
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', function(e) {
        if (!cartButtonMobile.contains(e.target) && !cartDropdownMobile.contains(e.target)) {
          cartDropdownMobile.classList.remove('show');
        }
      });
    }
  });

  search.start();

</script>