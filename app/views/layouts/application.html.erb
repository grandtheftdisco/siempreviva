<!DOCTYPE html>
<html>
  <%= render partial: "layouts/public/head" %>

  <body>
    <header>
      <div class="header-container">
          
        <!-- Logo -->
        <div class="logo-section">
          <a href="<%= root_path %>" class="logo-link">
            <%= image_tag 'logo.png', class: 'logo-image', alt: 'Logo' %>
          </a>
        </div>
      
        <!-- Navbar Links -->
        <div class="navbar-section" id="navbar-default">
          <ul class="navbar-list">
            <li><%= link_to 'Products', products_path %></li>
            <li><%= link_to 'Our Farms', our_farms_path %></li> 
            <li><%= link_to 'Learn', learn_path %></li>
            <li><%= link_to 'Contact', contact_path %></li>
          </ul>
        </div>

        <!-- Search Section -->
        <div class="search-section">
          <div id="searchbox" class="search-container"></div>
          <div id="hits" class="search-results"></div>
        </div>

        <!-- Right Side Icons -->
        <div class="right-icons">
          <!-- Cart Dropdown -->
          <button id="cartDropdownButton" class="cart-button">
            <!-- Shopping Cart Icon -->
            <svg class="cart-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 10.5V6a3.75 3.75 0 10-7.5 0v4.5m11.356-1.993l1.263 12c.07.665-.45 1.243-1.119 1.243H4.25a1.125 1.125 0 01-1.12-1.243l1.264-12A1.125 1.125 0 015.513 7.5h12.974c.576 0 1.059.435 1.119.993zM8.625 10.5a.375.375 0 11-.75 0 .375.375 0 01.75 0zm7.5 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z"></path>
            </svg>
            <!-- Cart Badge -->
            <span class="cart-badge"><%= @cart.cart_items.count %></span>
          </button>

          <!-- Dropdown Menu -->
          <div id="cartDropdown" class="cart-dropdown">
            <div class="cart-dropdown-header">
              <h3 class="cart-dropdown-title">My Bag</h3>
            </div>
            <ul class="cart-items-list">
            <% @cart.cart_items.each do |item| %>
              <li class="cart-item">
                <div class="cart-item-details">
                  <%= image_tag(item.image, class: "cart-item-image") %>
                  <p class="cart-item-name"><%= item.name %></p>
                  <p class="cart-item-price"><%= to_dollars(item.price) %></p>
                </div>
              </li>
            <% end %>
            </ul>
            <div class="cart-actions">
              <a href="<%= cart_path %>" class="cart-view-button">View Cart</a>
              <a href="<%= new_checkout_path %>" class="cart-checkout-button">Checkout</a>
            </div>
          </div>

          <!-- Mobile Menu Button -->
          <button data-collapse-toggle="navbar-default" type="button" class="mobile-menu-button">
            <span class="sr-only">Open main menu</span>
            <svg class="mobile-menu-icon" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
          </button>
        </div>
        </div>
      </header>
    <main>
      <%= render partial: "layouts/public/flash_alert" %>
      <%= yield %>
    </main>
  </body>
</html>

<script>
  // Initialize the search client

  const { liteClient: algoliasearch } = window['algoliasearch/lite'];
  const searchClient = algoliasearch('<%= Rails.application.credentials.algolia[:application_id] %>',
                                     '<%= Rails.application.credentials.algolia[:search_api_key] %>');

  // Render the InstantSearch.js wrapper
  const search = instantsearch({
    indexName: 'products_index',
    searchClient,
    searchFunction(helper) {
      // only search if the query is not empty
      if (helper.state.query.trim() === '') {
        // hide hits container if query is empty
        document.querySelector('#hits').style.display = 'none';
        return;
      }
      // show hits container and search
      document.querySelector('#hits').style.display = '';
      helper.search();
    }
  });

  search.addWidgets([
    instantsearch.widgets.searchBox({
      container: '#searchbox'
    }),

    instantsearch.widgets.hits({
      container: '#hits',
      templates: {
        item(hit, { html, components }) {

          const url = `/products/${hit.objectId}`;

          return html`
            <a href="${url}" class="search-hit-item">
              <h2>
                ${components.Highlight({ attribute: 'name', hit })}
              </h2>
            </a>
          `;
        },
      },
    })
  ]);

  // hide hits on initial load
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelector('#hits').style.display = 'none';

    // Cart dropdown functionality
    const cartButton = document.getElementById('cartDropdownButton');
    const cartDropdown = document.getElementById('cartDropdown');

    if (cartButton && cartDropdown) {
      cartButton.addEventListener('click', function(e) {
        e.preventDefault();

        // Toggle display
        if (cartDropdown.style.display === 'none' || cartDropdown.style.display === '') {
          cartDropdown.style.display = 'block';
        } else {
          cartDropdown.style.display = 'none';
        }
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', function(e) {
        if (!cartButton.contains(e.target) && !cartDropdown.contains(e.target)) {
          cartDropdown.style.display = 'none';
        }
      });
    }
  });

  search.start();

</script>